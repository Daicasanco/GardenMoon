<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhập Liệu Beta - Garden Moon</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        .beta-input-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .task-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .content-editor {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            min-height: 400px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .content-editor:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .word-count {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            color: #6c757d;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        
        .back-btn {
            background: linear-gradient(135deg, #6c757d, #495057);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }
        
        .status-badge {
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 15px;
        }
        
        .loading-spinner {
            display: none;
        }
        
        .loading-spinner.show {
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-arrow-left me-2"></i>
                Quay lại Bảng DL
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text" id="currentUserInfo">
                    <i class="fas fa-user me-1"></i>
                    <span id="currentUserName">Đang tải...</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="beta-input-container">
        <!-- Task Information -->
        <div class="task-info-card" id="taskInfoCard">
            <div class="row">
                <div class="col-md-8">
                    <h4 id="taskName">Đang tải thông tin...</h4>
                    <p id="taskDescription" class="mb-2">Mô tả: <span id="taskDescText">-</span></p>
                    <div class="row">
                        <div class="col-md-4">
                            <small><i class="fas fa-calendar me-1"></i> Deadline: <span id="taskDeadline">-</span></small>
                        </div>
                        <div class="col-md-4">
                            <small><i class="fas fa-user me-1"></i> Người thực hiện: <span id="taskAssignee">-</span></small>
                        </div>
                        <div class="col-md-4">
                            <small><i class="fas fa-info-circle me-1"></i> Trạng thái: <span id="taskStatus">-</span></small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <span class="status-badge bg-light text-dark" id="taskStatusBadge">-</span>
                </div>
            </div>
        </div>

        <!-- Content Editor -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    Nội dung Beta
                </h5>
            </div>
            <div class="card-body">
                <textarea 
                    class="form-control content-editor" 
                    id="betaContent" 
                    placeholder="Nhập nội dung beta tại đây..."
                    rows="20"
                ></textarea>
                
                <div class="word-count">
                    <i class="fas fa-text-width me-1"></i>
                    Số ký tự: <span id="charCount">0</span> | 
                    Số từ: <span id="wordCount">0</span>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between mt-4">
            <button class="btn back-btn" onclick="goBack()">
                <i class="fas fa-arrow-left me-2"></i>
                Quay lại
            </button>
            
            <div>
                <button class="btn btn-outline-secondary me-2" onclick="clearContent()">
                    <i class="fas fa-eraser me-2"></i>
                    Xóa nội dung
                </button>
                <button class="btn save-btn" onclick="saveBetaContent()">
                    <i class="fas fa-save me-2"></i>
                    <span id="saveBtnText">Lưu nội dung</span>
                    <span class="loading-spinner" id="saveSpinner">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto" id="toastTitle">Thông báo</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
                <!-- Message will be set here -->
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://blkkgtjsebkjmhqqtrwh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsa2tndGpzZWJram1ocXF0cndoIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzkzNzk0OCwiZXhwIjoyMDY5NTEzOTQ4fQ.B-YLv3Akz3OJ_gM6FtpftSgxC6OBmGOp9lToo5LMrvE'
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        // Global variables
        let currentUser = null
        let currentTask = null
        let taskId = null
        let mode = 'input' // 'input' or 'edit'
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializePage()
        })
        
        async function initializePage() {
            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search)
            taskId = urlParams.get('taskId')
            mode = urlParams.get('mode') || 'input'
            
            if (!taskId) {
                showNotification('Không tìm thấy thông tin task', 'error')
                setTimeout(() => goBack(), 2000)
                return
            }
            
            // Check authentication
            await checkAuthentication()
            
            // Load task information
            await loadTaskInfo()
            
            // Setup event listeners
            setupEventListeners()
        }
        
        async function checkAuthentication() {
            // Get user from localStorage (from main page)
            const savedUser = localStorage.getItem('currentUser')
            if (savedUser) {
                currentUser = JSON.parse(savedUser)
                document.getElementById('currentUserName').textContent = currentUser.name
            } else {
                showNotification('Vui lòng đăng nhập từ trang chính', 'error')
                setTimeout(() => goBack(), 2000)
                return
            }
        }
        
        async function loadTaskInfo() {
            try {
                // Get task information
                const { data: taskData, error } = await supabase
                    .from('tasks')
                    .select(`
                        *,
                        project:projects(name, status),
                        assignee:employees(name)
                    `)
                    .eq('id', taskId)
                    .single()
                
                if (error) throw error
                
                currentTask = taskData
                
                // Check permissions
                if (!canAccessTask(currentTask)) {
                    showNotification('Bạn không có quyền truy cập task này', 'error')
                    setTimeout(() => goBack(), 2000)
                    return
                }
                
                // Update UI with task information
                updateTaskInfoUI(currentTask)
                
                // Load existing content if in edit mode
                if (mode === 'edit' && currentTask.beta_link) {
                    await loadExistingContent()
                }
                
            } catch (error) {
                console.error('Error loading task info:', error)
                showNotification('Lỗi tải thông tin task', 'error')
            }
        }
        
        function canAccessTask(task) {
            if (!currentUser) return false
            
            // Boss can access any task
            if (currentUser.role === 'boss') return true
            
            // Manager can access tasks in their projects
            if (currentUser.role === 'manager') {
                return task.project && currentUser.id === task.project.manager_id
            }
            
            // Employee can only access their assigned tasks
            if (currentUser.role === 'employee') {
                return task.assignee_id === currentUser.id
            }
            
            return false
        }
        
        function updateTaskInfoUI(task) {
            document.getElementById('taskName').textContent = task.name
            document.getElementById('taskDescText').textContent = task.description || 'Không có mô tả'
            document.getElementById('taskDeadline').textContent = formatDateTime(task.deadline)
            document.getElementById('taskAssignee').textContent = task.assignee ? task.assignee.name : 'Chưa phân công'
            document.getElementById('taskStatus').textContent = getStatusText(task.status)
            document.getElementById('taskStatusBadge').textContent = getStatusText(task.status)
            
            // Update status badge color
            const statusBadge = document.getElementById('taskStatusBadge')
            statusBadge.className = 'status-badge ' + getStatusBadgeClass(task.status)
        }
        
        async function loadExistingContent() {
            try {
                if (currentTask.beta_link) {
                    // If beta_link is a URL, fetch content
                    if (currentTask.beta_link.startsWith('http')) {
                        const response = await fetch(currentTask.beta_link)
                        const content = await response.text()
                        document.getElementById('betaContent').value = content
                    } else {
                        // If it's direct content
                        document.getElementById('betaContent').value = currentTask.beta_link
                    }
                    updateWordCount()
                }
            } catch (error) {
                console.error('Error loading existing content:', error)
                showNotification('Lỗi tải nội dung hiện tại', 'error')
            }
        }
        
        function setupEventListeners() {
            // Word count update
            const contentEditor = document.getElementById('betaContent')
            contentEditor.addEventListener('input', updateWordCount)
            
            // Auto-save draft (optional)
            contentEditor.addEventListener('input', debounce(autoSaveDraft, 30000)) // Auto-save every 30 seconds
        }
        
        function updateWordCount() {
            const content = document.getElementById('betaContent').value
            const charCount = content.length
            const wordCount = content.trim() ? content.trim().split(/\s+/).length : 0
            
            document.getElementById('charCount').textContent = charCount.toLocaleString()
            document.getElementById('wordCount').textContent = wordCount.toLocaleString()
        }
        
        async function saveBetaContent() {
            const content = document.getElementById('betaContent').value.trim()
            
            if (!content) {
                showNotification('Vui lòng nhập nội dung beta', 'error')
                return
            }
            
            // Show loading state
            const saveBtn = document.querySelector('.save-btn')
            const saveBtnText = document.getElementById('saveBtnText')
            const saveSpinner = document.getElementById('saveSpinner')
            
            saveBtn.disabled = true
            saveBtnText.textContent = 'Đang lưu...'
            saveSpinner.classList.add('show')
            
            try {
                // Create a unique URL for this content (could be a blob URL or actual file storage)
                const contentUrl = await createContentUrl(content)
                
                // Update task in database
                const { error } = await supabase
                    .from('tasks')
                    .update({
                        beta_link: contentUrl,
                        beta_chars: content.length,
                        status: 'completed',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', taskId)
                
                if (error) throw error
                
                showNotification('Lưu nội dung beta thành công!', 'success')
                
                // Update save button text
                saveBtnText.textContent = 'Đã lưu'
                
                // Redirect back after a short delay
                setTimeout(() => goBack(), 1500)
                
            } catch (error) {
                console.error('Error saving beta content:', error)
                showNotification('Lỗi lưu nội dung: ' + error.message, 'error')
            } finally {
                // Reset button state
                saveBtn.disabled = false
                saveBtnText.textContent = 'Lưu nội dung'
                saveSpinner.classList.remove('show')
            }
        }
        
        async function createContentUrl(content) {
            // For now, we'll store the content directly in the beta_link field
            // In a real implementation, you might want to store files in Supabase Storage
            return content
        }
        
        function clearContent() {
            if (confirm('Bạn có chắc chắn muốn xóa toàn bộ nội dung?')) {
                document.getElementById('betaContent').value = ''
                updateWordCount()
            }
        }
        
        function goBack() {
            window.location.href = 'index.html'
        }
        
        // Utility functions
        function formatDateTime(dateString) {
            const date = new Date(dateString)
            return date.toLocaleString('vi-VN')
        }
        
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Chờ thực hiện',
                'in-progress': 'Đang thực hiện',
                'completed': 'Hoàn thành',
                'overdue': 'Quá hạn'
            }
            return statusMap[status] || status
        }
        
        function getStatusBadgeClass(status) {
            const classMap = {
                'pending': 'bg-warning',
                'in-progress': 'bg-info',
                'completed': 'bg-success',
                'overdue': 'bg-danger'
            }
            return classMap[status] || 'bg-secondary'
        }
        
        function showNotification(message, type = 'info') {
            const toast = document.getElementById('notificationToast')
            const toastTitle = document.getElementById('toastTitle')
            const toastMessage = document.getElementById('toastMessage')
            
            toastTitle.textContent = type === 'error' ? 'Lỗi' : 
                                   type === 'success' ? 'Thành công' : 
                                   type === 'warning' ? 'Cảnh báo' : 'Thông báo'
            toastMessage.textContent = message
            
            toast.className = `toast toast-${type}`
            
            const bsToast = new bootstrap.Toast(toast)
            bsToast.show()
        }
        
        function debounce(func, wait) {
            let timeout
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout)
                    func(...args)
                }
                clearTimeout(timeout)
                timeout = setTimeout(later, wait)
            }
        }
        
        async function autoSaveDraft() {
            const content = document.getElementById('betaContent').value.trim()
            if (content) {
                // Auto-save draft to localStorage
                localStorage.setItem(`beta_draft_${taskId}`, content)
            }
        }
    </script>
</body>
</html> 